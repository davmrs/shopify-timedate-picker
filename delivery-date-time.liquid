{{ '//code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css' | stylesheet_tag }}
{{ '//ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/jquery-ui.min.js' | script_tag }}

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.js"></script>

<script>
  // Datepicker configuration in Spanish
  $(function ($) {
    $.datepicker.regional["es"] = {
      closeText: "Cerrar",
      prevText: "&#x3c;Ant",
      nextText: "Sig&#x3e;",
      currentText: "Hoy",
      monthNames: [
        "Enero",
        "Febrero",
        "Marzo",
        "Abril",
        "Mayo",
        "Junio",
        "Julio",
        "Agosto",
        "Septiembre",
        "Octubre",
        "Noviembre",
        "Diciembre"
      ],
      monthNamesShort: [
        "Ene",
        "Feb",
        "Mar",
        "Abr",
        "May",
        "Jun",
        "Jul",
        "Ago",
        "Sep",
        "Oct",
        "Nov",
        "Dic"
      ],
      dayNames: [
        "Domingo",
        "Lunes",
        "Martes",
        "Mi&eacute;rcoles",
        "Jueves",
        "Viernes",
        "S&aacute;bado"
      ],
      dayNamesShort: [
        "Dom",
        "Lun",
        "Mar",
        "Mi&eacute;",
        "Juv",
        "Vie",
        "S&aacute;b"
      ],
      dayNamesMin: ["Do", "Lu", "Ma", "Mi", "Ju", "Vi", "S&aacute;"],
      weekHeader: "Sm",
      dateFormat: "yy/mm/dd",
      firstDay: 1,
      isRTL: false,
      showMonthAfterYear: false,
      yearSuffix: ""
    };
    $.datepicker.setDefaults($.datepicker.regional["es"]);
  });

  $(document).ready(function () {
    $(function () {
      // Getting current Date and Time
      var currentDate = new Date();
      var currentHour = currentDate.getHours();

      // Comment next line on Prod Env (Just for testing!!!) 
      // Hour in 24 format (0-23)
      // var currentHour = 11;

      var minDate = -0; // It enables today as a possible option to be selected

      // After 13h it is not possible to choose today
      if (currentHour >= 13) {
        minDate = 1;
      }

      $("#date").datepicker({
        minDate: minDate,
        maxDate: "+2M",
        onSelect: function (dateText) {
          var today = new Date(
            new Date().getFullYear(),
            new Date().getMonth(),
            new Date().getDate()
          ).getTime();
          var selected = new Date(dateText).getTime();
          var daySelected = new Date(dateText).getDay();
          // console.log('Selected day ' + daySelected);
          // console.log('Selected ' + selected);
          // console.log('Today ' + today);

          if (today > selected) {
            alert("fecha no v√°lida");
          } else if (today < selected) {
            // For a different day than today
            void 0;
            let minTime = "08:00 am";
            let maxTime = "7:00pm";

            // Getting the difference in days
            const diffTime = Math.abs(today - selected);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            // Comment next line on Prod Env (Just for testing!!!) 
            // const diffDays = 1;
            console.log(diffDays + " days");

            // After 18h the minTime available is 10h
            if (currentHour >= 18 && diffDays == 1) {
              minTime = "10:00 am";
            }

            // On purchases from Saturday to Sunday the minTime available is 15h
            if (daySelected == 0 && diffDays == 1) {
              minTime = "3:00pm";
            }

            // Setting Saturday and Sunday out of service hour: 5:00pm
            if (daySelected == 0 || daySelected == 6) {
              maxTime = "5:00pm";
            }

            let defaultTime = minTime.substring(0, 2);

            $(function () {
              // console.log("fecha diferente de hoy");
              // console.log(maxTime);
              $("#time").timepicker({
                timeFormat: "h:mm p",
                interval: 30,
                minTime: minTime,
                maxTime: maxTime,
                //defaultTime: defaultTime,
                //startTime: minTime,
                dynamic: false,
                dropdown: true,
                scrollbar: true
              });
            });

            $("#time").data("TimePicker").options.minTime = minTime;
            $("#time").data("TimePicker").options.maxTime = maxTime;
            $("#time").data("TimePicker").options.defaultTime = defaultTime;
            $("#time").data("TimePicker").options.startTime = minTime;
            $("#time").timepicker("setTime", minTime);
            /*  since v1.1.2 does not support changing most of the options, we need
                to trick the plugin into thinking the next time the dropdown needs
                to be displayed is the first time, so it re-generates the items, 
                using the new format */
            $("#time").data("TimePicker").items = null;
            $("#time").data("TimePicker").widget.instance = null;
          } else {
            // When the selected day is today
            let minTime = "";
            let maxTime = "7:00pm";

            if (currentHour >= 0 && currentHour < 10) {
              minTime = "03:00 pm";
            } else {
              minTime = "05:00 pm";
            }

            // Setting Saturday and Sunday out of service hour: 5:00pm
            if (daySelected == 0 || daySelected == 6) {
              maxTime = "5:00pm";
            }

            let defaultTime = minTime.substring(0, 2);
            // console.log(minTime, defaultTime);

            $(function () {
              // console.log("fecha hoy");
              $("#time").timepicker({
                timeFormat: "h:mm p",
                interval: 30,
                minTime: minTime,
                maxTime: maxTime,
                //defaultTime: defaultTime,
                //startTime: minTime,
                dynamic: false,
                dropdown: true,
                scrollbar: true
              });
            });

            $("#time").data("TimePicker").options.minTime = minTime;
            $("#time").data("TimePicker").options.maxTime = maxTime;
            $("#time").data("TimePicker").options.defaultTime = defaultTime;
            $("#time").data("TimePicker").options.startTime = minTime;
            $("#time").timepicker("setTime", minTime);
            /*  since v1.1.2 does not support changing most of the options, we need
                to trick the plugin into thinking the next time the dropdown needs
                to be displayed is the first time, so it re-generates the items, 
                using the new format */
            $("#time").data("TimePicker").items = null;
            $("#time").data("TimePicker").widget.instance = null;
          }
        }
      });
    });
  });  
</script>


<div style="width:300px; clear:both;">
  <p>
    <label for="date">Selecciona una fecha de entrega:</label>
    <input id="date" type="text" name="attributes[date]" value="{{ cart.attributes.date }}" />
  </p>
</div>
<div style="width:300px; clear:both;">
  <p>
    <label for="time">Selecciona una hora de entrega:</label>
    <input id="time" type="text" name="attributes[time]" value="{{ cart.attributes.time }}" />
  </p>
</div>
<div style="width:300px; clear:both;">
  <p>
    <span style="display:block" class="instructions"> Si no se ajusta a su horario de entrega, favor de comunicarse a la
      tienda para verificar disponibilidad.</span>
  </p>
  <p>
    <span style="display:block" class="instructions"> Para entregas el 14 de febrero y 10 de mayo, confirmar
      disponibilidad.</span>
  </p>
</div>